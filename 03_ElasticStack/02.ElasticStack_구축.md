# # Elastic Stack 구축

## 1. 대상 시스템

##### 시스템 종류

- FI(UCS)
- Openstack (Host log)
- Hyper-V(Host log)
- 스토리지(Netapp) - 7 mode, C mode
- 스위치



## 2. 진행 단계

### 2-1. Phase 1 (로그 수집)

##### #수집 대상

- 스위치 - N9K, N5K, N3K, MDS, SAN
- 스토리지 - Netapp
- CISCO FI

##### #추가사항

- 로그 포맷 수정



### 2-2. Phase 2 (호스트 로그 및 메트릭 수집)

- 호스트 서버 대상으로 호스트 로그 및 metric beat 수집
- 모니터링 구축



### 2-3. Phase 3 (Rabbit MQ)

- 메트릭 수집 및 모니터링



## 3. 아키텍처

![](https://github.com/dh77hd/Note/blob/master/00_image/elastic_01.PNG?raw=true)



## 4. 구축

### 4-1. Node 생성(OpenStack) 



### 4-2. Elasticsearch

#### 4-2-1. 설치

1. Repo 설정

   ```
   [elasticsearch-6.x]
   name=Elasticsearch repository for 6.x packages
   baseurl=https://artifacts.elastic.co/packages/6.x/yum
   gpgcheck=1
   gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
   enabled=1
   autorefresh=1
   type=rpm-md
   ```

2. Elasticsearch 설치

   ```
   sudo yum install elasticsearch -y
   ```

3. SysV init 과 systemd 중 어떤 서비스를 사용하는지 확인

   ```
   ps -p 1
   ```

4. systemd

   ```
   sudo /bin/systemctl daemon-reload
   sudo /bin/systemctl enable elasticsearch.service
   ```

5. 호스트네임 변경

   ```
   hostnamectl set-hostname [호스트네임]
   ```

#### 4-2-2. 경로

- 기본 프로그램 : /usr/share/elasticsearch
  - 실행 파일 : bin/elasticsearch
  - 플러그인 : plugins
- 설정 파일 : /etc/elasticsearch
  - elasticsearch.yml
  - jvm.options
  - log4j2.properties
- 데이터(path.data) : /var/lib/elasticsearch
- 로그 : /var/log/elasticsearch

#### 4-2-3. 기본 설정

1. 클러스터명 및 노드명 변경

   ```
   cluster.name: [클러스터 이름]
   ```

   ```
   node.name: ${HOSTNAME}
   ```

#### 4-2-4. 세부 설정

1. Java Heap 메모리 설정

   ```
   sudo vim /etc/elasticsearch/jvm.options
   ```

   ```
   -Xms8g
   -Xmx8g
   ```

   (Java Heap 외에 시스템 메모리의 절반은 루씬 파일 캐시용)

2. 네트워크 설정

   ```
   sudo vim /etc/elasticsearch/elasticsearch.yml
   ```

   ```
   network.host: [ IP | _local_ | _site_ | _global_ ]
   ```

3. Bootstrap Check 설정

   ```
   sudo vim /etc/elasticsearch/elasticsearch.yml
   ```

   ```
   bootstrap.memory_lock: true
   ```

   elasticsearch 재시작 후, 실행에 실패하면 시스템 로그를 확인하여 추가 설정 진행

   ```
   sudo vim /etc/security/limits.conf
   ```

   ```
   elasticsearch soft memlock unlimited
   elasticsearch hard memlock unlimited
   ```

4. Unicast 설정 (데이터노드 - 마스터노드 간의 연결 설정)

   ```
   sudo vim /etc/elasticsearch/elasticsearch.yml
   ```

   ```
   discovery.zen.ping.unicast.hosts: [마스터 노드 IP]
   ```

5. 노드 역할 설정 

   1. 마스터 노드 설정

   ```
   sudo vim /etc/elasticsearch/elasticsearch.yml
   ```

   ```
   node.master: true
   node.data: false
   ```

   2. 데이터 노드 설정

   ```
   sudo vim /etc/elasticsearch/elasticsearch.yml
   ```

   ```
   node.master: false
   node.data: true
   ```



### 4-3. Kibana

#### 4-3-1. 설치

1. Repo 설정

   ```
   [kibana-6.x]
   name=Kibana repository for 6.x packages
   baseurl=https://artifacts.elastic.co/packages/6.x/yum
   gpgcheck=1
   gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
   enabled=1
   autorefresh=1
   type=rpm-md
   ```

2. Kibana 설치

   ```
   sudo yum install kibana -y
   ```

3. SysV init 과 systemd 중 어떤 서비스를 사용하는지 확인

   ```
   ps -p 1
   ```

4. systemd

   ```
   sudo /bin/systemctl daemon-reload
   sudo /bin/systemctl enable kibana.service
   ```

#### 4-3-2. 경로

- 기본 프로그램 : /usr/share/kibana
  - 실행 파일 : bin/kibana
  - 플러그인 : plugins
- 설정 파일 : /etc/kibana/kibana.yml
- 데이터(path.data) : /var/lib/kibana
- 로그 : /var/log/kibana

#### 4-3-3. 기본 설정

1. Elasticsearch URL

   ```
   sudo vim /etc/kibana/kibana.yml
   ```

   ```
   elasticsearch.url: "http://MaterNodeIP:9200"
   ```

2. 외부 접근 주소

   ```
   server.host: "IP"
   ```



### 4-4. Logstash  

#### 4-4-1. 설치

1. Repo 설정

   ```
   [logstash-6.x]
   name=Elastic repository for 6.x packages
   baseurl=https://artifacts.elastic.co/packages/6.x/yum
   gpgcheck=1
   gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
   enabled=1
   autorefresh=1
   type=rpm-md
   ```

2. Kibana 설치

   ```
   sudo yum install logstash -y
   ```

3. SysV init 과 systemd 중 어떤 서비스를 사용하는지 확인

   ```
   ps -p 1
   ```

4. systemd

   ```
   sudo /bin/systemctl daemon-reload
   sudo /bin/systemctl enable logstash.service
   ```

#### 4-4-2. 경로

- 기본 프로그램 : /usr/share/logstash
  - 실행 파일 : bin/logstash
- 설정 파일 : /etc/logstash
  - logstash.yml
  - jvm.options
  - log4j2.properties
  - startup.options
  - pipeline.yml
- Config파일 : /etc/logstash/conf.d
- 플러그인 : /usr/share/logstash/plugins
- 데이터(path.data) : /var/lib/logstash
- 로그 : /var/log/logstash

#### 4-4-3. 기본 설정

1. 모니터링 설정

   ```
   sudo vim /etc/logstash/logstash.yml
   ```

   ```
   xpack.monitoring.elasticsearch.url: ["http://MaterNodeIP:9200"]
   ```

2. 관리 기능

   추가 라이센스 필요

3. 파이프 라인 설정

   ```
   sudo vim /etc/logstash/pipeline.yml
   ```

   ```
   - pipeline.id: [파이프라인 이름]
     path.config: "/etc/logstash/conf.d/[Config파일]"
   ```

4. Config 설정

#### 4-4-4. 로그 포맷 수정





### 4-5. Syslog 설정 





## # 참고

#========================== custom index setting =============================
output.elasticsearch.index: "metricbeat-mgtweb1-%{[beat.version]}-%{+yyyy.MM.dd}"
setup.template.name: "metricbeat-mgtweb1"
setup.template.pattern: "metricbeat-mgtweb1-*"



iptables -t nat -A PREROUTING -p UDP -m udp --dport 162 -j REDIRECT --to-ports 1162



[설치]

1. yum repo 갱신(centos)

   1. [base]
      name=CentOS-$releasever - Base
      baseurl=http://mirror.centos.org/centos/7/os/$basearch/
      gpgcheck=1

      #released updates
      [update]
      name=CentOS-$releasever - Updates
      baseurl=http://mirror.centos.org/centos/7/updates/$basearch/
      gpgcheck=1

   2. **#** rpm --import http://mirror.centos.org/centos/7/os/i386/RPM-GPG-KEY-CentOS-7

         **# rpm --import http://mirror.centos.org/centos/7/os/x86_64/RPM-GPG-KEY-CentOS-7**

2. java 설치

3. NTP 설정

4. jvm 설정

5. limit 설정

   1. /etc/security/limits.conf

   2. ```
      elasticsearch soft memlock unlimited
      elasticsearch hard memlock unlimited
      ```

6. 엑스팩 비밀번호 설정